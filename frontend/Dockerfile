FROM node:20-alpine AS build
WORKDIR /app
RUN apk add --no-cache python3 make g++
COPY package*.json ./
RUN npm ci
COPY . .
# Build-time public envs (injected via build args from CI)
ARG PUBLIC_WALLET_CONNECT_PROJECT_ID
ARG PUBLIC_API_URL
ARG PUBLIC_BADGE_REGISTRY_ADDRESS
ARG PUBLIC_EAS_CONTRACT_ADDRESS
ARG PUBLIC_ACTIVITY_TOKEN_ADDRESS
ARG PUBLIC_ATTESTATION_RESOLVER_ADDRESS
ARG PUBLIC_SCHEMA_ID

# Expose them to the build environment
ENV PUBLIC_WALLET_CONNECT_PROJECT_ID=$PUBLIC_WALLET_CONNECT_PROJECT_ID \
    PUBLIC_API_URL=$PUBLIC_API_URL \
    PUBLIC_BADGE_REGISTRY_ADDRESS=$PUBLIC_BADGE_REGISTRY_ADDRESS \
    PUBLIC_EAS_CONTRACT_ADDRESS=$PUBLIC_EAS_CONTRACT_ADDRESS \
    PUBLIC_ACTIVITY_TOKEN_ADDRESS=$PUBLIC_ACTIVITY_TOKEN_ADDRESS \
    PUBLIC_ATTESTATION_RESOLVER_ADDRESS=$PUBLIC_ATTESTATION_RESOLVER_ADDRESS \
    PUBLIC_SCHEMA_ID=$PUBLIC_SCHEMA_ID
RUN npm run build

FROM node:20-alpine
WORKDIR /app
ENV NODE_ENV=production
COPY --from=build /app ./
# keep CMD as:
CMD ["node", "./dist/server/entry.mjs"]
